<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>高雄 · 陳其邁市長任內活動地圖（2020–2026/01/01）</title>

  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

  <style>
    *{ box-sizing:border-box; }
    html, body{ height:100%; overflow:hidden; }
    body{
      margin:0;
      font-family:"AR 浪漫明朝體","Noto Serif TC","Noto Sans TC",system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",serif;
      background:
        radial-gradient(circle at top left, rgba(220,205,196,0.65), transparent 55%),
        radial-gradient(circle at bottom right, rgba(182,196,201,0.75), #f4f1ec);
      color:#3f3f46;
    }

    .app{ height:100dvh; display:flex; flex-direction:column; min-height:0; }

    .header{
      padding:10px 18px;
      display:flex; align-items:center; justify-content:space-between;
      border-bottom:1px solid rgba(148,133,121,0.4);
      background: linear-gradient(to right, #d8c3a5, #e3d5ca, #c9ada7);
      gap:10px;
    }
    .title{
      display:flex; flex-direction:column; gap:3px;
      min-width: 260px;
    }
    .title h1{
      margin:0;
      font-size:18px; font-weight:800; letter-spacing:.12em;
      text-transform:uppercase;
      color:#403b33;
    }
    .title .sub{
      font-size:12px;
      color:#5b5b63;
    }
    .badge{
      font-size:11px;
      padding:6px 12px;
      border-radius:999px;
      border:1px solid rgba(112,99,88,0.5);
      background: rgba(244,241,236,0.75);
      display:inline-flex;
      align-items:center; gap:8px;
      color:#3f3f46; white-space:nowrap;
    }
    .badge-dot{
      width:7px; height:7px; border-radius:999px;
      background:#9a8c98;
      box-shadow:0 0 0 3px rgba(154,140,152,0.35);
    }

    .main{
      flex:1;
      display:grid;
      grid-template-columns:minmax(0,1.35fr) minmax(0,1.65fr);
      min-height:0;
    }

    .map-wrapper{ padding:14px 14px 14px 18px; }
    .map-card{
      height:100%;
      border-radius:18px;
      overflow:hidden;
      border:1px solid rgba(148,133,121,0.5);
      box-shadow:0 20px 35px rgba(64,59,51,0.25);
    }
    #map{ height:100%; width:100%; }

    .sidebar{
      padding:14px 18px 12px;
      display:flex; flex-direction:column;
      border-left:1px solid rgba(148,133,121,0.45);
      background: linear-gradient(to bottom, rgba(244,241,236,0.85), rgba(227,213,202,0.85));
      min-height:0;
      overflow:hidden;
    }

    .scope-title{
      font-size:17px; font-weight:800; color:#5e503f;
      margin-bottom:2px;
    }
    .scope-sub{
      font-size:13px; color:#6b7280;
    }
    .hint{
      margin-top:8px;
      font-size:12px; color:#78716c;
      line-height:1.4;
    }

    .row{ margin-top:10px; display:flex; flex-wrap:wrap; gap:6px; align-items:center; }

    .select-label{
      font-size:12px;
      color:#6b7280;
      padding-left:2px;
      min-width: 40px;
    }
    .select{
      flex:1;
      min-width: 180px;
      font-size:12px;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid #c8b6a6;
      background: rgba(244,241,236,0.9);
      color:#1f2937;
      outline:none;
    }
    .select:focus{
      border-color:#9a8c98;
      box-shadow:0 0 0 3px rgba(154,140,152,0.25);
    }

    .thumb-btn{
      appearance:none;
      border:none;
      padding:0;
      cursor:pointer;
      text-align:left;
    }
    .thumb-btn:focus-visible{
      outline:3px solid rgba(185,87,86,0.45);
      outline-offset:2px;
    }

    /* Lightbox */
    .lightbox{
      position:fixed;
      inset:0;
      display:none;
      z-index:9999;
    }
    .lightbox.open{ display:block; }
    .lightbox-backdrop{
      position:absolute;
      inset:0;
      background: rgba(15,15,15,0.72);
      backdrop-filter: blur(2px);
    }
    .lightbox-panel{
      position:absolute;
      left:50%;
      top:50%;
      transform: translate(-50%,-50%);
      width:min(92vw, 980px);
      max-height: 88vh;
      background: rgba(253,253,252,0.98);
      border:1px solid rgba(200,182,166,0.9);
      border-radius:18px;
      box-shadow: 0 30px 60px rgba(0,0,0,0.35);
      overflow:hidden;
      display:flex;
      flex-direction:column;
    }
    .lightbox-close{
      position:absolute;
      right:10px;
      top:10px;
      width:34px;
      height:34px;
      border-radius:12px;
      border:1px solid rgba(112,99,88,0.45);
      background: rgba(244,241,236,0.95);
      cursor:pointer;
      font-size:18px;
      line-height:1;
      color:#403b33;
    }
    .lightbox-imgwrap{
      padding:12px 12px 0;
      display:flex;
      justify-content:center;
      align-items:center;
      min-height: 220px;
    }
    .lightbox-panel img{
      max-width:100%;
      max-height: calc(88vh - 130px);
      border-radius:14px;
      border:1px solid rgba(148,133,121,0.35);
      background: #f4f1ec;
    }
    .lightbox-meta{
      padding:10px 14px 14px;
      border-top:1px solid rgba(200,182,166,0.55);
      background: linear-gradient(to bottom, rgba(244,241,236,0.95), rgba(227,213,202,0.9));
      font-size:12px;
      color:#403b33;
      display:flex;
      flex-direction:column;
      gap:6px;
      word-break:break-all;
    }
    .lightbox-meta a{
      color:#B95756;
      text-decoration: underline;
      text-underline-offset: 2px;
    }

    .pill{
      font-size:11px;
      padding:7px 12px;
      border-radius:999px;
      border:1px solid #c8b6a6;
      background:#e3d5ca;
      color:#1f2937;
      cursor:pointer;
      transition:transform .08s, border-color .18s, background .18s;
    }
    .pill:hover{ transform: translateY(-1px); border-color:#9a8c98; }
    .pill.active{
      background:#c9ada7;
      border-color:#9a8c98;
      color:#111827;
      font-weight:900;
    }

    .btn{
      margin-left:auto;
      font-size:11px;
      padding:7px 10px;
      border-radius:12px;
      border:1px solid rgba(112,99,88,0.5);
      background: rgba(244,241,236,0.9);
      color:#403b33;
      cursor:pointer;
    }

    .event-list{
      margin-top:10px;
      flex:1;
      overflow-y:auto;
      padding-right:4px;
      min-height:0;
    }

    .event-card{
      background:#fdfdfc;
      border-radius:14px;
      padding:10px 12px;
      margin-bottom:10px;
      border:1px solid rgba(200,182,166,0.9);
      box-shadow:0 12px 25px rgba(64,59,51,0.12);
    }
    .event-header{ display:flex; align-items:baseline; gap:8px; margin-bottom:6px; flex-wrap:wrap; }
    .event-date{
      font-size:12px;
      padding:2px 8px;
      border-radius:999px;
      background:#d8e2dc;
      color:#344054;
      border:1px solid #b5c3c7;
      white-space:nowrap;
    }
    .event-name{ font-size:14px; font-weight:900; color:#3b3a3a; }

    .event-meta{
      display:flex; flex-wrap:wrap;
      gap:6px;
      font-size:12px; color:#6b6b6b;
      margin-bottom:8px;
    }
    .tag{
      display:inline-flex; align-items:center; gap:6px;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid #c8b6a6;
      font-size:11px;
      background:#f4f1ec;
    }
    .tag-dot{ width:6px; height:6px; border-radius:999px; background:#9a8c98; }

    .photo-row{
      margin-top:6px;
      display:grid;
      grid-template-columns: repeat(auto-fill, minmax(92px, 1fr));
      gap:6px;
    }
    .thumb{
      position:relative;
      width:100%;
      padding-bottom:65%;
      border-radius:10px;
      overflow:hidden;
      border:1px solid rgba(148,133,121,0.85);
      background-position:center;
      background-size:cover;
      background-repeat:no-repeat;
      background-color: rgba(244,241,236,0.9);
    }
    .thumb.placeholder::after{
      content:"尚未加入照片";
      position:absolute; inset:0;
      display:flex; align-items:center; justify-content:center;
      font-size:11px;
      color:#fdfdfc;
      text-shadow:0 1px 3px rgba(0,0,0,0.8);
      background: linear-gradient(to top, rgba(64,59,51,0.92), rgba(64,59,51,0.28));
    }

    .missing-box{
      margin-top:9px;
      padding:12px;
      border-radius:12px;
      border:1px solid #d2b48c;
      background: #fffaf0;
      color:#403b33;
      font-size:14px;
      line-height:1.6;
    }
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", monospace;
      font-size:11px;
    }

    .pin-icon{ background:transparent; border:none; }
    .pin-icon svg{ filter: drop-shadow(0 10px 10px rgba(64,59,51,0.25)); }

    .footer{
      padding:8px 18px 10px;
      font-size:11px;
      color:#6b6b6b;
      border-top:1px solid rgba(148,133,121,0.5);
      background:#e3d5ca;
    }

    @media (max-width: 960px){
      .header{ flex-direction:column; align-items:flex-start; }
      .main{
        grid-template-columns:1fr;
        grid-template-rows:minmax(280px, 46vh) minmax(0, 54vh);
      }
      .map-wrapper{ padding:10px 12px 6px; }
      .sidebar{ border-left:none; border-top:1px solid rgba(148,133,121,0.45); }
    }
  </style>
</head>

<body>
  <div class="app">
    <header class="header">
      <div class="title">
        <h1>KAOHSIUNG EVENTS MAP</h1>
        <div class="sub">陳其邁任內活動整理 · 2020–2026/01/01</div>
      </div>
      <div class="badge"><span class="badge-dot"></span>點地圖圖釘 → 右側看該地點歷年活動</div>
    </header>

    <div class="main">
      <div class="map-wrapper">
        <div class="map-card"><div id="map"></div></div>
      </div>

      <aside class="sidebar">
        <div class="scope-title" id="scopeTitle">全部地點</div>
        <div class="scope-sub" id="scopeSub">目前顯示：全部年份 · 全部活動</div>

        <div class="row">
          <span class="select-label">地點</span>
          <select id="placeSelect" class="select" aria-label="選擇地點"></select>
        </div>
        <div class="row" id="yearFilters"></div>

        <div class="row">
          <button class="btn" id="clearPlace">清除地點篩選（回到全部）</button>
        </div>

        <div class="event-list" id="eventList"></div>
      </aside>
    </div>

    <footer class="footer">
      地圖：OpenStreetMap + Leaflet（座標為近似位置，可再微調）。
    </footer>
  </div>

  <div class="lightbox" id="lightbox" aria-hidden="true">
    <div class="lightbox-backdrop" id="lightboxBackdrop" data-close="1"></div>
    <div class="lightbox-panel" role="dialog" aria-modal="true" aria-label="圖片放大檢視">
      <button class="lightbox-close" id="lightboxClose" aria-label="關閉">✕</button>
      <div class="lightbox-imgwrap">
        <img id="lightboxImg" alt="放大圖片"/>
      </div>
      <div class="lightbox-meta">
        <div><b>圖片路徑：</b><span class="mono" id="lightboxPath"></span></div>
        <div><b>圖片來源網址：</b><a id="lightboxSrc" href="#" target="_blank" rel="noopener noreferrer"></a></div>
      </div>
    </div>
  </div>

<script>
  const PLACES = [
    { id:"meinong", name:"美濃客家文物館", lat:22.9005, lng:120.5420 },
    { id:"love_river_bay", name:"愛河灣", lat:22.6178, lng:120.2889 },
    { id:"kmc", name:"高雄流行音樂中心（高流）", lat:22.6169, lng:120.2874 },
    { id:"penglai", name:"蓬萊商港區", lat:22.6199, lng:120.2817 },
    { id:"pier2", name:"駁二藝術特區", lat:22.6205, lng:120.2799 },
    { id:"kaohsiung_harbor", name:"高雄港灣 / 港區", lat:22.6130, lng:120.2850 },
    { id:"love_river", name:"愛河", lat:22.6305, lng:120.2955 },
    { id:"weiwuying", name:"衛武營", lat:22.6255, lng:120.3452 },
    { id:"nknu", name:"高師大（高雄師範大學）", lat:22.6276, lng:120.3320 },
    { id:"dream_mall", name:"夢時代 / 時代大道", lat:22.59515, lng:120.30692 },
    { id:"lotus_lake", name:"左營蓮池潭", lat:22.6842, lng:120.2975 },
    { id:"arena", name:"高雄巨蛋", lat:22.6692, lng:120.3017 },
    { id:"world_games", name:"世運主場館（國家體育場）", lat:22.7023, lng:120.2947 },
    { id:"qijin", name:"旗津海水浴場", lat:22.61018, lng:120.2669 },
    { id:"pier7", name:"高雄港七號碼頭", lat:22.6138, lng:120.2835 },
    { id:"aozihdi", name:"凹子底森林公園", lat:22.6637, lng:120.3020 },
    { id:"central_park", name:"中央公園", lat:22.6246, lng:120.3006 },
    { id:"city_hall", name:"高雄市政府（四維行政中心）", lat:22.6230, lng:120.3140 },
    { id:"science_museum", name:"國立科工館", lat:22.6399, lng:120.3248 },
  ];
  const placeById = Object.fromEntries(PLACES.map(p => [p.id, p]));

  const EVENTS = [
    { id:"2020-10-meinong-hakka-trip", year:2020, month:10, monthLabel:"10月", name:"好客旅遊去", kind:"民俗文化", places:["meinong"] },
    { id:"2020-12-newyear-cross-lightyears", year:2020, month:12, monthLabel:"12月", name:"跨百光年跨年晚會", kind:"節慶（市長首場）", places:["love_river_bay","kmc","penglai"] },

    { id:"2021-03-megaport-restart", year:2021, month:3, monthLabel:"03月", name:"大港開唱（復辦首年）", kind:"音樂祭", places:["pier2"] },
    { id:"2021-05-ocean-party", year:2021, month:5, monthLabel:"05月", name:"高雄海洋派對", kind:"水域休閒", places:["love_river_bay"] },
    { id:"2021-10-national-day-fireworks", year:2021, month:10, monthLabel:"10月", name:"國慶煙火在高雄", kind:"國家慶典", places:["kaohsiung_harbor"] },
    { id:"2021-11-dragonboat-carnival", year:2021, month:11, monthLabel:"11月", name:"國慶龍舟嘉年華", kind:"運動賽事", places:["love_river"] },
    { id:"2021-12-newyear-2022-dual-stage", year:2021, month:12, monthLabel:"12月", name:"2022 高雄跨年（雙舞台）", kind:"節慶晚會", places:["kmc","penglai"] },

    { id:"2022-02-taiwan-lantern-festival", year:2022, month:2, monthLabel:"02月", name:"2022 台灣燈會（雙主場）", kind:"國際級節慶", places:["weiwuying","love_river_bay"] },
    { id:"2022-03-ksaf", year:2022, month:3, monthLabel:"03月", name:"高雄春天藝術節（KSAF）", kind:"藝文盛會", places:["weiwuying","nknu"] },
    { id:"2022-08-creativexpo-floating", year:2022, month:8, monthLabel:"08月", name:"台灣文博會（聊療漂漂河）", kind:"藝文 IP", places:["love_river_bay","kmc"] },
    { id:"2022-10-design-expo", year:2022, month:10, monthLabel:"10月", name:"台灣設計展（設計中島）", kind:"藝文設計", places:["penglai"] },
    { id:"2022-10-takao-rock", year:2022, month:10, monthLabel:"10月", name:"Takao Rock 打狗祭", kind:"音樂祭", places:["kmc"] },
    { id:"2022-12-newyear-2023-yawan", year:2022, month:12, monthLabel:"12月", name:"2023 跨年亞灣未來市", kind:"節慶晚會", places:["dream_mall"] },

    { id:"2023-01-lotus-lake-lantern", year:2023, month:1, monthLabel:"01月", name:"蓮潭燈會（萌兔）", kind:"節慶（首度移師）", places:["lotus_lake"] },
    { id:"2023-02-westlife-bsb", year:2023, month:2, monthLabel:"02月", name:"Westlife & Backstreet Boys", kind:"國際演唱會", places:["arena","world_games"] },
    { id:"2023-03-blackpink-born-pink", year:2023, month:3, monthLabel:"03月", name:"BLACKPINK［BORN PINK］", kind:"國際演唱會", places:["world_games"] },
    { id:"2023-04-a-mei-and-megaport", year:2023, month:4, monthLabel:"04月", name:"張惠妹 ASMR / 大港開唱", kind:"音樂慶典", places:["arena","pier2"] },
    { id:"2023-08-qijin-kite", year:2023, month:8, monthLabel:"08月", name:"旗津風箏節", kind:"親子觀光", places:["qijin"] },
    { id:"2023-10-green-knights-show", year:2023, month:10, monthLabel:"10月", name:"翡翠騎士（日農二高）展演", kind:"國際交流", places:["pier7"] },
    { id:"2023-11-coldplay", year:2023, month:11, monthLabel:"11月", name:"Coldplay 酷玩樂團", kind:"國際演唱會", places:["world_games"] },
    { id:"2023-12-newyear-2024", year:2023, month:12, monthLabel:"12月", name:"2024 跨年晚會", kind:"節慶晚會", places:["dream_mall"] },

    { id:"2024-01-winter-duck", year:2024, month:1, monthLabel:"01月", name:"冬日遊樂園（黃色小鴨回歸）", kind:"國際亮點 IP", places:["love_river_bay"] },
    { id:"2024-02-ed-sheeran", year:2024, month:2, monthLabel:"02月", name:"Ed Sheeran 紅髮艾德", kind:"國際演唱會", places:["world_games"] },
    { id:"2024-03-sakura-mayday", year:2024, month:3, monthLabel:"03月", name:"高雄櫻花季 / 五月天", kind:"音樂祭 / 演唱會", places:["dream_mall","world_games"] },
    { id:"2024-04-golden-wave", year:2024, month:4, monthLabel:"04月", name:"Golden Wave in Taiwan", kind:"韓流拼盤", places:["world_games"] },
    { id:"2024-07-beer-festival", year:2024, month:7, monthLabel:"07月", name:"高雄啤酒音樂節", kind:"商業祭典", places:["dream_mall"] },
    { id:"2024-09-bruno-mars", year:2024, month:9, monthLabel:"09月", name:"Bruno Mars 火星人布魯諾", kind:"國際演唱會", places:["world_games"] },
    { id:"2024-09-one-ok-rock", year:2024, month:9, monthLabel:"09月", name:"ONE OK ROCK 演唱會", kind:"國際演唱會", places:["world_games"] },
    { id:"2024-10-orange-devils-greenknights", year:2024, month:10, monthLabel:"10月", name:"橘色惡魔、翡翠騎士回訪", kind:"國際交流", places:["kaohsiung_harbor"] },
    { id:"2024-10-takao-rock-halloween", year:2024, month:10, monthLabel:"10月", name:"打狗祭 / 萬聖節大遊行", kind:"音樂 / 節慶", places:["kmc","aozihdi"] },
    { id:"2024-11-stray-kids", year:2024, month:11, monthLabel:"11月", name:"Stray Kids 世界巡迴", kind:"韓流演唱會", places:["world_games"] },
    { id:"2024-12-lisa-meet", year:2024, month:12, monthLabel:"12月", name:"Lisa（Blackpink）見面會", kind:"國際演唱會", places:["arena"] },
    { id:"2024-12-squid-game-2", year:2024, month:12, monthLabel:"12月", name:"魷魚遊戲 2 進駐高雄", kind:"國際 IP 快閃", places:["pier2"] },
    { id:"2024-12-christmas-life-2025", year:2024, month:12, monthLabel:"12月", name:"2025 聖誕生活節", kind:"節慶點燈", places:["central_park"] },
    { 
  id: "2024-12-newyear-2025", 
  year: 2024, 
  month: 12, 
  monthLabel: "12月", 
  name: "2025 高雄跨年「亞灣星海奇航」", 
  kind: "節慶晚會", 
  places: ["dream_mall"],
  desc: "這場跨年最猛的就是竟然請到了 Sandara Park！看到 2NE1 的偶像出現在夢時代大螢幕，台下尖叫聲真的快把時代大道掀翻了。其邁市長那天看起來心情也很好，跟大家一起倒數迎接高雄設市百年。那晚250秒的亞灣花火配上愛心圖案，身邊的人都在拍照留念，那種全高雄聚在一起慶祝的感覺，現在想起來還是覺得心裡暖暖的。" 
},

    { id:"2025-01-newyear-2025", year:2025, month:1, monthLabel:"01月", name:"2025 跨年晚會 / 元旦升旗", kind:"節慶晚會", places:["dream_mall","city_hall"] },
    { id:"2025-01-day6", year:2025, month:1, monthLabel:"01月", name:"DAY6 世界巡迴演唱會", kind:"韓流演唱會", places:["kmc"] },
    { id:"2025-02-maroon5", year:2025, month:2, monthLabel:"02月", name:"Maroon 5 魔力紅", kind:"國際演唱會", places:["world_games"] },
    { id:"2025-02-winter-chiikawa", year:2025, month:2, monthLabel:"02月", name:"冬日遊樂園（吉伊卡哇）", kind:"療癒 IP 展", places:["pier2","love_river_bay"] },
    { id:"2025-03-megaport-sakura", year:2025, month:3, monthLabel:"03月", name:"2025 大港開唱 / 櫻花季", kind:"音樂祭", places:["pier2","dream_mall"] },
    { id:"2025-08-qijin-summer", year:2025, month:8, monthLabel:"08月", name:"旗津風箏節暨氣墊水樂園", kind:"暑假活動", places:["qijin"] },
    { id:"2025-10-takao-rock-2025", year:2025, month:10, monthLabel:"10月", name:"2025 打狗祭", kind:"音樂祭", places:["kmc"] },
    { id:"2025-11-doraemon", year:2025, month:11, monthLabel:"11月", name:"100% 哆啦A夢特展", kind:"IP 特展", places:["science_museum"] },
    { 
      id: "2025-12-newyear-2026", 
      year: 2025, 
      month: 12, 
      monthLabel: "12月", 
      name: "2026 跨年晚會「雄嗨趴」", 
      kind: "節慶晚會", 
      places: ["dream_mall"],
      desc: "跨年夜這晚，夢時代這頭真的被擠得水洩不通，大家的情緒跟舞台上的告五人、八三夭一樣嗨。最難忘的一幕，是其邁市長陪著大家一起數到一，看著 240 秒的高空花火在亞灣區炸開時，那種『這就是高雄』的驕傲感真的油然而生。這不只是一場晚會，更像是我們全高雄人聚在一起慶祝這座城市的不斷進步。" 
    },
    { id:"2026-01-superjunior-ss10", year:2026, month:1, monthLabel:"01月", name:"Super Junior SS10（1/23-25）", kind:"國際演唱會", places:["arena"] },
  ];

  let activePlace = "all";
  let activeYear = "all";

  const scopeTitleEl = document.getElementById("scopeTitle");
  const scopeSubEl   = document.getElementById("scopeSub");
  const yearFiltersEl= document.getElementById("yearFilters");
  const eventListEl  = document.getElementById("eventList");
  const placeSelectEl = document.getElementById("placeSelect");

  const PHOTO_SOURCES = {
    "images/2025/2025-12-newyear-2026/01.jpg": "https://taidaily.com/2026/01/01/563572/",
    "images/2025/2025-12-newyear-2026/02.jpg": "https://taidaily.com/2026/01/01/563572/",
    "images/2025/2025-12-newyear-2026/03.jpg": "https://taidaily.com/2026/01/01/563572/",
    "images/2025/2025-12-newyear-2026/04.jpg": "https://taidaily.com/2026/01/01/563572/",
  };

  function getAvailableYears(){
    let list = EVENTS;
    if (activePlace !== "all") list = list.filter(e => e.places.includes(activePlace));
    return Array.from(new Set(list.map(e => e.year))).sort((a,b)=>a-b);
  }
  function ensureActiveYearValid(){
    const years = getAvailableYears();
    if (activeYear !== "all" && !years.includes(Number(activeYear))){
      activeYear = "all";
    }
  }

  function renderPlaceSelect(){
    placeSelectEl.innerHTML = `<option value="all">全部地點 (不限地點)</option>` + 
      PLACES.map(p => `<option value="${p.id}">${p.name}</option>`).join("");
    
    placeSelectEl.addEventListener("change", (e)=>{
      activePlace = e.target.value;
      renderYearFilters();
      renderEvents();
    });
  }

  function renderYearFilters(){
    ensureActiveYearValid();
    const years = getAvailableYears();
    const buttons = ["all", ...years];

    yearFiltersEl.innerHTML = buttons.map(y=>{
      const label = y === "all" ? "全部年份" : String(y);
      const isActive = String(y) === String(activeYear);
      return `<button class="pill ${isActive ? "active":""}" data-year="${y}">${label}</button>`;
    }).join("");

    yearFiltersEl.querySelectorAll("button").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        activeYear = btn.dataset.year;
        renderYearFilters();
        renderEvents();
      });
    });
  }

  function expectedFolder(ev){
    return `images/${ev.year}/${ev.id}/`;
  }

  function tryLoadImage(url){
    return new Promise(resolve=>{
      const img = new Image();
      img.onload = ()=> resolve(url);
      img.onerror= ()=> resolve(null);
      img.src = url + `?v=${Date.now()}`;
    });
  }

  async function loadEventPhotos(ev){
    const base = expectedFolder(ev);
    const candidates = [];
    for (let i=1;i<=6;i++){
      const n = String(i).padStart(2,"0");
      candidates.push(`${base}${n}.jpg`);
    }
    const results = await Promise.all(candidates.map(tryLoadImage));
    return results.filter(Boolean);
  }

  function renderEvents(){
    const year = (activeYear === "all") ? null : Number(activeYear);
    let list = EVENTS.slice();
    if (year) list = list.filter(e => e.year === year);
    if (activePlace !== "all") list = list.filter(e => e.places.includes(activePlace));

    list.sort((a,b)=>{
      if (a.year !== b.year) return b.year - a.year;
      if (a.month !== b.month) return b.month - a.month;
      return a.name.localeCompare(b.name, "zh-Hant");
    });

    if (activePlace === "all"){
      scopeTitleEl.textContent = "全部地點";
    } else {
      scopeTitleEl.textContent = placeById[activePlace]?.name || "單一地點";
    }
    scopeSubEl.textContent = `目前顯示：${activeYear === "all" ? "全部年份" : activeYear} · 共 ${list.length} 筆活動`;

    if (!list.length){
      eventListEl.innerHTML = `<div class="hint">目前條件下沒有活動，請切換年份或清除地點篩選。</div>`;
      return;
    }

    eventListEl.innerHTML = list.map(ev=>{
      const placeNames = ev.places.map(pid => placeById[pid]?.name || pid).join("、");
      const placeholderThumbs = Array.from({length:2}).map((_,idx)=>{
        return `<div class="thumb placeholder" id="ph-${ev.id}-${idx}"></div>`;
      }).join("");

      return `
        <article class="event-card" id="card-${ev.id}">
          <div class="event-header">
            <span class="event-date">${ev.year} 年 ${ev.monthLabel}</span>
            <span class="event-name">${ev.name}</span>
          </div>

          <div class="event-meta">
            <span class="tag"><span class="tag-dot"></span><span>${ev.kind}</span></span>
            <span class="tag">${placeNames}</span>
          </div>

          <div class="photo-row" id="photos-${ev.id}">
            ${placeholderThumbs}
          </div>

          <div class="missing-box">
            <div style="font-weight: 800; color: #8b4513; margin-bottom: 4px; font-size: 13px; display: flex; align-items: center; gap: 5px;">
              <span>✨</span> 活動亮點紀錄
            </div>
            <div style="text-align: justify;">
              ${ev.desc || "活動詳情整理中，敬請期待市長當天的精彩紀錄！"}
            </div>
          </div>
        </article>
      `;
    }).join("");

    list.forEach(async ev=>{
      const urls = await loadEventPhotos(ev);
      const container = document.getElementById(`photos-${ev.id}`);
      if (!container || !urls.length) return;

      container.innerHTML = urls.map(url=>{
        const src = PHOTO_SOURCES[url] || url;
        return `<button class="thumb thumb-btn" type="button" aria-label="放大圖片" data-img="${url}" data-src="${src}" style="background-image:url('${url}')"></button>`;
      }).join("");
    });
  }

  const lightboxEl = document.getElementById("lightbox");
  const lightboxImg = document.getElementById("lightboxImg");
  const lightboxPath = document.getElementById("lightboxPath");
  const lightboxSrc = document.getElementById("lightboxSrc");
  const lightboxClose = document.getElementById("lightboxClose");
  const lightboxBackdrop = document.getElementById("lightboxBackdrop");

  function openLightbox(imgUrl, srcUrl){
    lightboxImg.src = imgUrl;
    lightboxPath.textContent = imgUrl;
    lightboxSrc.textContent = srcUrl || imgUrl;
    lightboxSrc.href = srcUrl || imgUrl;
    lightboxEl.classList.add("open");
    lightboxEl.setAttribute("aria-hidden","false");
    document.body.style.overflow = "hidden";
  }

  function closeLightbox(){
    lightboxEl.classList.remove("open");
    lightboxEl.setAttribute("aria-hidden","true");
    document.body.style.overflow = "";
    lightboxImg.src = "";
  }

  eventListEl.addEventListener("click", (e)=>{
    const btn = e.target.closest(".thumb-btn");
    if (!btn) return;
    const imgUrl = btn.dataset.img;
    const srcUrl = btn.dataset.src || btn.dataset.img;
    if (imgUrl) openLightbox(imgUrl, srcUrl);
  });

  lightboxClose.addEventListener("click", closeLightbox);
  lightboxBackdrop.addEventListener("click", closeLightbox);
  document.addEventListener("keydown", (e)=>{
    if (e.key === "Escape" && lightboxEl.classList.contains("open")) closeLightbox();
  });

  const map = L.map("map").setView([22.63, 120.30], 12);
  L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
    maxZoom: 19,
    attribution: "&copy; OpenStreetMap 貢獻者"
  }).addTo(map);

  const PIN_ICON = L.divIcon({
    className: "pin-icon",
    html: `
      <svg width="28" height="44" viewBox="0 0 28 44" xmlns="http://www.w3.org/2000/svg" aria-hidden="true">
        <path d="M14 43C14 43 3 28.7 3 18C3 10.8 8.1 5 14 5C19.9 5 25 10.8 25 18C25 28.7 14 43 14 43Z"
              fill="#B95756" stroke="#8F4A49" stroke-width="2"/>
        <circle cx="14" cy="18" r="6" fill="#f4f1ec" stroke="#9a8c98" stroke-width="2"/>
      </svg>
    `,
    iconSize: [28, 44],
    iconAnchor: [14, 44],
    tooltipAnchor: [0, -34]
  });

  const usedPlaceIds = new Set(EVENTS.flatMap(e => e.places));
  PLACES.filter(p => usedPlaceIds.has(p.id)).forEach(p=>{
    const marker = L.marker([p.lat, p.lng], { icon: PIN_ICON }).addTo(map);
    marker.bindTooltip(p.name, { direction:"top" });
    marker.on("click", ()=>{
      activePlace = p.id;
      placeSelectEl.value = p.id;
      renderYearFilters();
      renderEvents();
    });
  });

  document.getElementById("clearPlace").addEventListener("click", ()=>{
    activePlace = "all";
    placeSelectEl.value = "all";
    renderYearFilters();
    renderEvents();
  });

  renderPlaceSelect();
  renderYearFilters();
  renderEvents();
</script>
</body>
</html>



